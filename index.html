<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gratis</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Roboto:wght@400&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #000; --primary: #fff; --secondary: #aaa; --accent: #1DB954; --card: #181818; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg); color: var(--primary); margin: 0; }
        #splashScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 2000; transition: opacity 0.5s; }
        #splashScreen h1 { font-family: 'Montserrat', sans-serif; font-size: 3rem; color: var(--accent); }
        #preferencesOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 1500; text-align: center; padding: 20px; box-sizing: border-box; }
        #preferencesOverlay h2 { font-family: 'Montserrat', sans-serif; }
        .genre-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .genre-tag { background: var(--card); border: 1px solid var(--card); padding: 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .genre-tag.selected { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: bold; }
        .btn { background-color: var(--accent); color: var(--primary); border: none; padding: 15px 30px; border-radius: 50px; cursor: pointer; font-size: 1rem; font-weight: bold; }
        .btn:disabled { background-color: #555; cursor: not-allowed; }
        #mainContent { padding: 20px; }
        #mainContent h1 { font-family: 'Montserrat', sans-serif; }
        .song-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .song-card { cursor: pointer; }
        .song-card img { width: 100%; border-radius: 8px; aspect-ratio: 1/1; object-fit: cover; }
        .song-card p { margin: 8px 0 0; font-size: 0.9rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #player-section { position: sticky; bottom: 0; background: #121212; padding: 10px; border-top: 1px solid #282828; }
        #player-ui { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        #player-controls, #extra-controls { display: flex; align-items: center; justify-content: center; gap: 20px; }
        .control-btn { background: none; border: none; cursor: pointer; }
        #video-container { width: 100%; transition: height 0.3s; height: 200px; }
        #player { width: 100%; height: 100%; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(22px); }
    </style>
</head>
<body>

    <div id="splashScreen"><h1>Gratis</h1></div>

    <div id="preferencesOverlay">
        <h2>What is your Taste</h2>?</h2>
        <p>Choose atleast three.</p>
        <div id="genreGrid" class="genre-grid"></div>
        <button id="submitPreferences" class="btn" disabled>Done</button>
    </div>

    <main id="mainContent" style="display: none;">
        <h1>Gratis</h1>
        <div id="homeContent"></div>
    </main>
    
    <section id="player-section" style="display:none;">
        <div id="video-container"><div id="player"></div></div>
        <div id="player-ui">
            <div id="player-controls">
                <button class="control-btn" onclick="seek(-10)"><svg height="24" viewBox="0 0 24 24" fill="#fff"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6l-8.5 6z"/></svg></button>
                <button class="control-btn" id="playPauseBtn"><svg height="36" viewBox="0 0 24 24" fill="#fff"><path d="M8 5v14l11-7z"/></svg></button>
                <button class="control-btn" onclick="seek(10)"><svg height="24" viewBox="0 0 24 24" fill="#fff"><path d="m18 6-8.5 6 8.5 6V6zm-2 12h-2V6h2v12z"/></svg></button>
            </div>
            <div id="extra-controls">
                <span>Video</span>
                <label class="switch"><input type="checkbox" id="videoToggle" checked onchange="toggleVideo()"><span class="slider"></span></label>
                <span>Autoplay</span>
                <label class="switch"><input type="checkbox" id="autoplayToggle" checked><span class="slider"></span></label>
            </div>
        </div>
    </section>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const apiKey = 'AIzaSyANPsMp-6jzO3wectka_kmhQCuevFE0Nyw'; // *** IMPORTANT: REPLACE WITH YOUR API KEY ***
        
        let player;
        let currentPlaylist = [];
        let currentSongIndex = 0;
        const genres = ['English Pop', 'Bollywood Hits', 'Punjabi Hits', 'Lofi Hip Hop', 'Indie India', 'Workout Music', 'Sad Songs Hindi', 'Romantic Songs'];

        // --- Core Functions ---
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%',
                playerVars: { 'playsinline': 1, 'controls': 0, 'modestbranding': 1, 'rel': 0 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerReady() {
            setTimeout(() => {
                document.getElementById('splashScreen').style.opacity = '0';
                setTimeout(() => document.getElementById('splashScreen').style.display = 'none', 500);
                
                const prefs = localStorage.getItem('userPreferences');
                if (!prefs) {
                    initPreferences();
                } else {
                    document.getElementById('mainContent').style.display = 'block';
                    loadHomePage(JSON.parse(prefs));
                }
            }, 1500);
        }

        function onPlayerStateChange(event) {
            const playIcon = '<svg height="36" viewBox="0 0 24 24" fill="#fff"><path d="M8 5v14l11-7z"/></svg>';
            const pauseIcon = '<svg height="36" viewBox="0 0 24 24" fill="#fff"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
            document.getElementById('playPauseBtn').innerHTML = event.data === YT.PlayerState.PLAYING ? pauseIcon : playIcon;

            if (event.data === YT.PlayerState.ENDED && document.getElementById('autoplayToggle').checked) {
                currentSongIndex++;
                if (currentSongIndex < currentPlaylist.length) {
                    playSong(currentPlaylist[currentSongIndex]);
                }
            }
        }
        
        function playSong(song) {
            document.getElementById('player-section').style.display = 'block';
            player.loadVideoById(song.videoId);
            player.playVideo();
            // Create a playlist of related songs
            fetchAndDisplay(`related to ${song.title} by ${song.channel}`, document.getElementById(`related-${song.videoId.substring(0,5)}`), 10, true);
        }

        // --- UI & Preferences ---
        function initPreferences() {
            const grid = document.getElementById('genreGrid');
            genres.forEach(g => {
                grid.innerHTML += `<div class="genre-tag" onclick="toggleGenre(this)">${g}</div>`;
            });
            document.getElementById('preferencesOverlay').style.display = 'flex';
            document.getElementById('submitPreferences').onclick = () => {
                const selected = Array.from(document.querySelectorAll('.genre-tag.selected')).map(el => el.textContent);
                localStorage.setItem('userPreferences', JSON.stringify(selected));
                document.getElementById('preferencesOverlay').style.display = 'none';
                onPlayerReady();
            };
        }
        
        function toggleGenre(el) {
            el.classList.toggle('selected');
            const selectedCount = document.querySelectorAll('.genre-tag.selected').length;
            document.getElementById('submitPreferences').disabled = selectedCount < 3;
        }

        function loadHomePage(preferences) {
            const homeContent = document.getElementById('homeContent');
            homeContent.innerHTML = '';
            preferences.forEach(pref => {
                homeContent.innerHTML += `<h2 class="section-title">${pref}</h2><div class="song-grid" id="grid-${pref.replace(/s+/g, '')}"></div>`;
                fetchAndDisplay(pref, document.getElementById(`grid-${pref.replace(/s+/g, '')}`), 6);
            });
        }
        
        async function fetchAndDisplay(query, element, maxResults = 10, isRelated = false) {
            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=${maxResults}&q=${query}&type=video&videoCategoryId=10&key=${apiKey}`);
                const data = await response.json();
                element.innerHTML = '';
                if (data.items) {
                    if(isRelated) currentPlaylist = [];
                    data.items.forEach(item => {
                        if (!item.id.videoId) return;
                        const song = { videoId: item.id.videoId, title: item.snippet.title, channel: item.snippet.channelTitle, thumbnail: item.snippet.thumbnails.medium.url };
                        if(isRelated) currentPlaylist.push(song);
                        element.innerHTML += `
                            <div class="song-card" onclick='playSong(${JSON.stringify(song)})'>
                                <img src="${song.thumbnail}" alt="Thumbnail">
                                <p>${song.title}</p>
                            </div>
                        `;
                    });
                    if(isRelated) element.innerHTML += `<div id="related-${song.videoId.substring(0,5)}"></div>`;
                }
            } catch (error) {
                console.error('API Error:', error);
            }
        }

        // --- Player Controls ---
        function togglePlay() {
            const state = player.getPlayerState();
            state === YT.PlayerState.PLAYING ? player.pauseVideo() : player.playVideo();
        }
        document.getElementById('playPauseBtn').onclick = togglePlay;
        
        function seek(seconds) {
            player.seekTo(player.getCurrentTime() + seconds, true);
        }
        
        function toggleVideo() {
            const container = document.getElementById('video-container');
            container.style.height = document.getElementById('videoToggle').checked ? '200px' : '0px';
        }

        // --- Service Worker ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('/service-worker.js'));
        }
    </script>
</body>
</html>
