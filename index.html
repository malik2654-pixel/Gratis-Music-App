<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gratis</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #121212; --primary: #fff; --secondary: #b3b3b3; --accent: #1DB954; --card: #181818; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--primary); margin: 0; }
        .container { padding: 20px; }
        .hidden { display: none !important; }
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 100; transition: opacity 0.5s ease; }
        #splash-screen h1 { font-size: 3rem; color: var(--accent); }
        #preferences-screen { text-align: center; }
        #preferences-screen h2 { font-size: 1.5rem; }
        .genre-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0; }
        .genre-tag { background: var(--card); border: 1px solid #282828; padding: 15px; border-radius: 8px; cursor: pointer; }
        .genre-tag.selected { background: var(--accent); color: var(--bg); font-weight: bold; }
        .submit-btn { background: var(--accent); color: var(--primary); border: none; padding: 15px 30px; border-radius: 50px; font-size: 1rem; cursor: pointer; }
        .submit-btn:disabled { background: #555; }
        #main-app h1 { font-size: 2rem; }
        .search-box { width: 100%; box-sizing: border-box; background: var(--card); border: 1px solid #282828; border-radius: 8px; padding: 15px; color: var(--primary); font-size: 1rem; margin-bottom: 20px; }
        .section-title { font-size: 1.2rem; font-weight: 700; margin: 25px 0 15px; }
        .song-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .song-card img { width: 100%; border-radius: 8px; aspect-ratio: 1/1; object-fit: cover; }
        .song-card p { font-size: 0.9rem; margin-top: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #player-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #282828; padding: 10px; box-sizing: border-box; }
        #player-container { height: 0; overflow: hidden; }
        .controls { display: flex; justify-content: space-around; align-items: center; }
        .control-btn { background: none; border: none; fill: var(--primary); cursor: pointer; }
    </style>
</head>
<body>

    <div id="splash-screen"><h1>Gratis</h1></div>

    <div id="app-container" class="container">
        <div id="preferences-screen" class="hidden">
            <h2>[translat:Your Music Taste]</h2>
            <p>[translate:Choose Atleast Three]</p>
            <div id="genre-options" class="genre-grid"></div>
            <button id="pref-submit-btn" class="submit-btn" disabled>Done</button>
        </div>
        <div id="main-app" class="hidden">
            <h1>Gratis</h1>
            <input type="text" id="search-input" class="search-box" placeholder="Search for songs...">
            <div id="home-sections"></div>
            <div id="search-results" class="hidden"></div>
        </div>
    </div>

    <div id="player-bar" class="hidden">
        <div id="player-container"></div>
        <div class="controls">
            <button class="control-btn" onclick="app.seek(-10)">-10s</button>
            <button class="control-btn" id="play-pause-btn">Play</button>
            <button class="control-btn" onclick="app.seek(10)">+10s</button>
        </div>
    </div>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const app = {
            apiKey: 'AIzaSyANPsMp-6jzO3wectka_kmhQCuevFE0Nyw',
            player: null,
            genres: ['English Pop', 'Bollywood Hits', 'Punjabi Hits', 'Lofi Hip Hop', 'Indie India', 'Workout Music', 'Sad Songs Hindi', 'Romantic Songs'],
            
            init() {
                document.addEventListener('DOMContentLoaded', () => {
                    this.ui.splash.style.opacity = '0';
                    setTimeout(() => {
                        this.ui.splash.classList.add('hidden');
                        this.loadUser();
                    }, 500);
                });
            },
            
            loadUser() {
                const prefs = localStorage.getItem('userPreferences');
                if (prefs) {
                    this.showMainApp(JSON.parse(prefs));
                } else {
                    this.showPreferences();
                }
            },
            
            showPreferences() {
                this.ui.preferences.classList.remove('hidden');
                const grid = this.ui.genreOptions;
                this.genres.forEach(g => grid.innerHTML += `<div class="genre-tag" onclick="app.toggleGenre(this)">${g}</div>`);
                this.ui.prefSubmit.onclick = () => {
                    const selected = Array.from(document.querySelectorAll('.genre-tag.selected')).map(el => el.textContent);
                    localStorage.setItem('userPreferences', JSON.stringify(selected));
                    this.ui.preferences.classList.add('hidden');
                    this.showMainApp(selected);
                };
            },

            toggleGenre(el) {
                el.classList.toggle('selected');
                this.ui.prefSubmit.disabled = document.querySelectorAll('.genre-tag.selected').length < 3;
            },

            showMainApp(prefs) {
                this.ui.main.classList.remove('hidden');
                prefs.forEach(pref => {
                    const section = document.createElement('div');
                    section.innerHTML = `<h2 class="section-title">${pref}</h2><div class="song-grid" id="grid-${pref.replace(/s/g,'')}"></div>`;
                    this.ui.home.appendChild(section);
                    this.fetchSongs(pref, section.querySelector('.song-grid'), 6);
                });
                this.ui.search.onkeypress = (e) => {
                    if (e.key === 'Enter' && this.ui.search.value) this.handleSearch();
                };
            },

            handleSearch() {
                this.ui.home.classList.add('hidden');
                this.ui.searchResults.classList.remove('hidden');
                this.ui.searchResults.innerHTML = `<h2 class="section-title">Results for "${this.ui.search.value}"</h2><div class="song-grid"></div>`;
                this.fetchSongs(this.ui.search.value, this.ui.searchResults.querySelector('.song-grid'));
            },

            async fetchSongs(query, element, limit = 20) {
                if (!this.apiKey || this.apiKey === 'AIzaSyANPsMp-6jzO3wectka_kmhQCuevFE0Nyw') {
                    element.innerHTML = "<p>Error: API Key is not configured.</p>";
                    return;
                }
                try {
                    const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=${limit}&q=${query}&type=video&videoCategoryId=10&key=${this.apiKey}`);
                    if (res.status === 403) {
                         element.innerHTML = "<p>Error: Daily API quota exceeded. Please try again tomorrow.</p>";
                         return;
                    }
                    const data = await res.json();
                    element.innerHTML = data.items.map(item => `
                        <div class="song-card" onclick="app.playSong('${item.id.videoId}')">
                            <img src="${item.snippet.thumbnails.medium.url}" alt="thumbnail">
                            <p>${item.snippet.title}</p>
                        </div>`).join('');
                } catch (err) {
                    element.innerHTML = "<p>Could not load songs.</p>";
                }
            },

            playSong(videoId) {
                this.ui.playerBar.classList.remove('hidden');
                if (this.player) {
                    this.player.loadVideoById(videoId);
                } else {
                    window.onYouTubeIframeAPIReady = () => {
                        this.player = new YT.Player('player-container', {
                            height: '80', width: '100%', videoId: videoId,
                            playerVars: { 'playsinline': 1 },
                            events: { 'onReady': (e) => e.target.playVideo() }
                        });
                    };
                    if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
                        const tag = document.createElement('script');
                        tag.src = "https://www.youtube.com/iframe_api";
                        document.head.appendChild(tag);
                    }
                }
                this.ui.playPause.onclick = () => this.togglePlay();
            },

            togglePlay() {
                if (this.player && typeof this.player.getPlayerState === 'function') {
                    this.player.getPlayerState() === YT.PlayerState.PLAYING ? this.player.pauseVideo() : this.player.playVideo();
                }
            },

            seek(s) {
                if (this.player) this.player.seekTo(this.player.getCurrentTime() + s, true);
            },

            ui: {
                splash: document.getElementById('splash-screen'),
                preferences: document.getElementById('preferences-screen'),
                main: document.getElementById('main-app'),
                home: document.getElementById('home-sections'),
                searchResults: document.getElementById('search-results'),
                genreOptions: document.getElementById('genre-options'),
                prefSubmit: document.getElementById('pref-submit-btn'),
                search: document.getElementById('search-input'),
                playerBar: document.getElementById('player-bar'),
                playPause: document.getElementById('play-pause-btn'),
            }
        };

        app.init();
    </script>
</body>
</html>
